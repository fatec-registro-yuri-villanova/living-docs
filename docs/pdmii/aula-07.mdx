---
sidebar_position: 7
title: "Aula 07: Ktor Client e Coroutines"
description: "Cliente HTTP com Ktor, chamadas ass√≠ncronas com Coroutines e exibi√ß√£o de dados remotos."
---

# Aula 07: Ktor Client e Coroutines

:::info üîÄ Branch da Aula
Esta aula refere-se √† branch: **`aula-07`**
```bash
git checkout aula-07
```
:::

## üìñ Conceito

Nesta aula, o app faz sua **primeira chamada real a uma API externa**. Usamos o **Ktor Client** para requisi√ß√µes HTTP e **Coroutines** para execut√°-las de forma ass√≠ncrona sem travar a UI.

### Arquivos novos nesta branch

| Arquivo | Descri√ß√£o |
|---------|-----------|
| `data/remote/KtorClient.kt` | HttpClient configurado com ContentNegotiation |
| `domain/models/PostInfo.kt` | Data class para deserializa√ß√£o da API |
| `ui/screens/aula07/Aula07ViewModel.kt` | ViewModel que busca dados da API |
| `ui/screens/aula07/Aula07Screen.kt` | Tela que exibe os posts carregados |

## üíª C√≥digo de Refer√™ncia

### KtorClient ‚Äî HttpClient Base

```kotlin title="data/remote/KtorClient.kt"
object KtorClient {
    val httpClient = HttpClient(Android) {
        install(ContentNegotiation) {
            json(Json {
                ignoreUnknownKeys = true // Se a API enviar campos extras, n√£o d√° crash
                isLenient = true // Aceita JSON mal formatado em alguns casos
            })
        }
    }
}
```

### PostInfo ‚Äî Modelo de dados

```kotlin title="domain/models/PostInfo.kt"
@Serializable
data class PostInfo(
    val userId: Int,
    val id: Int,
    val title: String,
    val body: String
)
```

### Aula07ViewModel ‚Äî Chamada ass√≠ncrona real

```kotlin title="ui/screens/aula07/Aula07ViewModel.kt"
data class Aula07UiState(
    val posts: List<PostInfo> = emptyList(),
    val isLoading: Boolean = false,
    val errorMessage: String? = null
)

class Aula07ViewModel : ViewModel() {
    private val _uiState = MutableStateFlow(Aula07UiState())
    val uiState: StateFlow<Aula07UiState> = _uiState.asStateFlow()

    fun fetchPosts() {
        // ViewModelScope √© uma Coroutine atrelada √† vida √∫til da Tela.
        // Se a tela for destru√≠da, a call morre junto,
        // economizando mem√≥ria e bateria.
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(isLoading = true, errorMessage = null)
            try {
                // Suspende a execu√ß√£o (fora da Main Thread) aguardando o Backend
                val response: List<PostInfo> = KtorClient.httpClient
                    .get("https://jsonplaceholder.typicode.com/posts")
                    .body()

                // Sucesso: popula a lista de posts e retira o Loading
                _uiState.value = _uiState.value.copy(
                    posts = response,
                    isLoading = false
                )
            } catch (e: Exception) {
                e.printStackTrace()
                // Erro: exibe a mensagem amig√°vel e retira o Loading
                _uiState.value = _uiState.value.copy(
                    isLoading = false,
                    errorMessage = "Falha ao buscar dados: ${e.localizedMessage}"
                )
            }
        }
    }
}
```

:::tip viewModelScope
O `viewModelScope` √© automaticamente cancelado quando o ViewModel √© destru√≠do. Isso evita **memory leaks** ‚Äî se o usu√°rio sai da tela durante uma chamada de rede, a coroutine √© cancelada automaticamente.
:::

## üíª M√£o na Massa

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
  <TabItem value="ex1" label="Exerc√≠cio 1 ‚Äî Fixa√ß√£o" default>

### Exiba a lista de posts

Na `Aula07Screen`, use `LazyColumn` para exibir a `list<PostInfo>` com cada post mostrando `title` e `body` (truncado a 100 caracteres com `take(100)`).

  </TabItem>
  <TabItem value="ex2" label="Exerc√≠cio 2 ‚Äî Aplica√ß√£o">

### Adicione tratamento de estados

Implemente 3 estados visuais na tela:
1. **Loading** ‚Üí `CircularProgressIndicator` centralizado
2. **Erro** ‚Üí Mensagem em vermelho + bot√£o "Tentar Novamente"
3. **Sucesso** ‚Üí Lista de posts

Use o `when` com `uiState.isLoading`, `uiState.errorMessage` e `uiState.posts`.

  </TabItem>
  <TabItem value="ex3" label="Exerc√≠cio 3 ‚Äî Desafio">

### Busque uma segunda API

Crie um `Comment` model e busque `https://jsonplaceholder.typicode.com/comments?postId={id}`. Ao clicar em um post, navegue para uma tela de detalhes que exibe o post + seus coment√°rios.

  </TabItem>
</Tabs>
