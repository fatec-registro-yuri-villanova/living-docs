---
sidebar_position: 9
title: "Aula 09: RepositÃ³rios e Koin"
description: "PadrÃ£o Repository para abstraÃ§Ã£o de dados e injeÃ§Ã£o de dependÃªncia com Koin."
---

# Aula 09: RepositÃ³rios e Koin

:::info ðŸ”€ Branch da Aula
Esta aula refere-se Ã  branch: **`aula-09`**
```bash
git checkout aula-09
```
:::

## ðŸ“– Conceito

O **Repository Pattern** Ã© uma camada de abstraÃ§Ã£o entre os ViewModels e as fontes de dados (API, banco local, cache). O **Koin** Ã© um framework de injeÃ§Ã£o de dependÃªncia leve e idiomÃ¡tico para Kotlin.

### Por que Repository?

```
ViewModel â†’ Repository â†’ DataSource (API / DB / Cache)
```

- O ViewModel **nÃ£o sabe** de onde os dados vÃªm
- Facilita testes: mock do Repository = ViewModel testÃ¡vel
- Centraliza lÃ³gica de cache e fallback

### Koin â€” InjeÃ§Ã£o de DependÃªncia

```kotlin
// 1. Defina os mÃ³dulos
val appModule = module {
    // Singleton
    single { KtorClient.httpClient }

    // Factory (nova instÃ¢ncia a cada pedido)
    factory { CourseRepository(get()) }

    // ViewModel
    viewModel { HomeViewModel(get()) }
    viewModel { (courseId: String) ->
        CourseDetailViewModel(courseId, get())
    }
}

// 2. Inicialize no Application
class MergeSkillsApp : Application() {
    override fun onCreate() {
        super.onCreate()
        startKoin {
            androidContext(this@MergeSkillsApp)
            modules(appModule)
        }
    }
}

// 3. Use no Compose
@Composable
fun HomeScreen(
    viewModel: HomeViewModel = koinViewModel()
) { /* ... */ }
```

## ðŸ’» CÃ³digo de ReferÃªncia

```kotlin title="di/AppModule.kt"
val networkModule = module {
    single {
        HttpClient(CIO) {
            install(ContentNegotiation) { json(Json { ignoreUnknownKeys = true }) }
            install(DefaultRequest) {
                url(ApiConfig.BASE_URL)
                header("X-Timezone", TimeZone.getDefault().id)
            }
        }
    }
}

val repositoryModule = module {
    factory { CourseRepository(get()) }
    factory { ProgressRepository(get()) }
}

val viewModelModule = module {
    viewModel { HomeViewModel(get()) }
    viewModel { (courseId: String) -> CourseDetailViewModel(courseId, get()) }
}

val appModules = listOf(networkModule, repositoryModule, viewModelModule)
```

## ðŸ’» MÃ£o na Massa

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
  <TabItem value="ex1" label="ExercÃ­cio 1 â€” FixaÃ§Ã£o" default>

### Configure o Koin no projeto

Adicione a dependÃªncia do Koin no `build.gradle.kts` e crie a classe `MergeSkillsApp` com `startKoin`. Registre-a no `AndroidManifest.xml`.

**CritÃ©rio:** O app deve iniciar sem erros e os ViewModels devem ser injetados via `koinViewModel()`.

  </TabItem>
  <TabItem value="ex2" label="ExercÃ­cio 2 â€” AplicaÃ§Ã£o">

### Crie o `ProgressRepository`

Implemente um `ProgressRepository` que tenha:
- `getHistory(userId: String): List<ProgressDto>` â€” `GET /progress/history/{userId}`
- `submitAnswer(request: SubmitRequest): SubmitResponse` â€” `POST /progress/submit`

Registre no `repositoryModule` do Koin.

  </TabItem>
  <TabItem value="ex3" label="ExercÃ­cio 3 â€” Desafio">

### Integre Repository + ViewModel + NavegaÃ§Ã£o

Refatore toda a cadeia usando Koin:
1. `HomeViewModel` recebe `CourseRepository` via construtor (injetado pelo Koin)
2. `CourseDetailViewModel` recebe `courseId` + `CourseRepository`
3. Remove qualquer instanciaÃ§Ã£o manual (`= CourseRepository()`)
4. Teste navegando entre Home â†’ Curso â†’ LiÃ§Ãµes usando dados reais da API

  </TabItem>
</Tabs>
