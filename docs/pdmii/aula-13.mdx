---
sidebar_position: 13
title: "Aula 13: Auth com Supabase"
description: "Fluxo de autenticaÃ§Ã£o completo com Supabase: login, registro, persistÃªncia de token com DataStore."
---

# Aula 13: Auth com Supabase

:::info ğŸ”€ Branch da Aula
Esta aula refere-se Ã  branch: **`aula-13`**
```bash
git checkout aula-13
```
:::

## ğŸ“– Conceito

A autenticaÃ§Ã£o Ã© a porta de entrada do MergeSkills. Usamos **Supabase Auth** para gerenciar login e registro, e **DataStore** para persistir o token localmente.

### Fluxo de AutenticaÃ§Ã£o

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     POST /auth/login     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Login   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚  Server  â”‚
â”‚  Screen  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ (Ktor)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     { token, user }      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”‚  Salva token no DataStore
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Home   â”‚
â”‚  Screen  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### DataStore para Token

```kotlin
class AuthDataStore(private val context: Context) {
    private val dataStore = context.dataStore

    val tokenFlow: Flow<String?> = dataStore.data.map { prefs ->
        prefs[TOKEN_KEY]
    }

    suspend fun saveToken(token: String) {
        dataStore.edit { prefs -> prefs[TOKEN_KEY] = token }
    }

    suspend fun clearToken() {
        dataStore.edit { prefs -> prefs.remove(TOKEN_KEY) }
    }

    companion object {
        private val TOKEN_KEY = stringPreferencesKey("auth_token")
    }
}
```

:::tip Regra da Spec
O registro deve gerar o `username` automaticamente a partir do email. Ex: `yuri@fatec.edu` â†’ `yuri`.
:::

## ğŸ’» CÃ³digo de ReferÃªncia

```kotlin title="repository/AuthRepository.kt"
class AuthRepository(
    private val client: HttpClient,
    private val dataStore: AuthDataStore
) {
    suspend fun login(email: String, password: String): Result<User> {
        return try {
            val response: LoginResponse = client.post("/auth/login") {
                setBody(LoginRequest(email, password))
            }.body()

            dataStore.saveToken(response.token)
            Result.Success(response.user)
        } catch (e: Exception) {
            Result.Error(e.message ?: "Erro ao fazer login")
        }
    }

    suspend fun register(email: String, password: String): Result<User> {
        val username = email.substringBefore("@") // Auto-generate
        return try {
            val response: LoginResponse = client.post("/auth/register") {
                setBody(RegisterRequest(email, password, username))
            }.body()

            dataStore.saveToken(response.token)
            Result.Success(response.user)
        } catch (e: Exception) {
            Result.Error(e.message ?: "Erro ao registrar")
        }
    }

    suspend fun logout() {
        dataStore.clearToken()
    }

    fun isLoggedIn(): Flow<Boolean> = dataStore.tokenFlow.map { it != null }
}
```

## ğŸ’» MÃ£o na Massa

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
  <TabItem value="ex1" label="ExercÃ­cio 1 â€” FixaÃ§Ã£o" default>

### Configure o DataStore

Adicione a dependÃªncia do DataStore Preferences no `build.gradle.kts` e crie a extensÃ£o:
```kotlin
val Context.dataStore by preferencesDataStore(name = "merge_skills_prefs")
```

  </TabItem>
  <TabItem value="ex2" label="ExercÃ­cio 2 â€” AplicaÃ§Ã£o">

### Crie as telas de Login e Registro

Implemente `LoginScreen` e `RegisterScreen` com campos de email e senha (`StitchTextField` com shape `Medium 12.dp`), `StitchButton` para submissÃ£o, tratamento de estados (loading, erro, sucesso), e navegaÃ§Ã£o entre login e registro.

  </TabItem>
  <TabItem value="ex3" label="ExercÃ­cio 3 â€” Desafio">

### Fluxo de auth completo com redirecionamento

No `AppNavigation`, verifique se hÃ¡ token salvo no DataStore. Se logado â†’ navegue para Home. Se nÃ£o logado â†’ navegue para Login. ApÃ³s login bem-sucedido â†’ redirecione para Home e limpe o back stack. Logout limpa o token e volta para Login. Integre com Koin (Aula 09) e o tema MergeSkills (Aula 04).

  </TabItem>
</Tabs>
