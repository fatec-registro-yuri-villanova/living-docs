---
sidebar_position: 5
title: "Aula 05: ViewModel e UDF (Unidirectional Data Flow)"
description: "Padr√£o Action/UiState/ViewModel com MutableStateFlow, sealed interface e viewModelScope."
---

# Aula 05: ViewModel e UDF

:::info üîÄ Branch da Aula
Esta aula refere-se √† branch: **`aula-05`**
```bash
git checkout aula-05
```
:::

## üìñ Conceito

O **ViewModel** sobrevive a rota√ß√µes de tela e gerencia o estado da UI. Usamos o padr√£o **UDF (Unidirectional Data Flow)**: `Action ‚Üí ViewModel ‚Üí UiState ‚Üí UI`.

### Arquivos novos nesta branch

| Arquivo | Descri√ß√£o |
|---------|-----------|
| `ui/screens/aula05/Aula05Action.kt` | Sealed interface com a√ß√µes do usu√°rio |
| `ui/screens/aula05/Aula05UiState.kt` | Data class do estado da UI |
| `ui/screens/aula05/Aula05ViewModel.kt` | ViewModel com l√≥gica de neg√≥cio |
| `ui/screens/aula05/Aula05Screen.kt` | Tela Compose que consome o estado |

### O Fluxo UDF

```
Usu√°rio clica ‚Üí Action (sealed interface)
                      ‚Üì
               ViewModel (processa)
                      ‚Üì
               UiState (data class)
                      ‚Üì
               Compose (recomp√µe)
```

## üíª C√≥digo de Refer√™ncia

### 1. Actions ‚Äî O que o usu√°rio pode fazer

```kotlin title="ui/screens/aula05/Aula05Action.kt"
sealed interface Aula05Action {
    data class OnNameChanged(val name: String) : Aula05Action
    object OnSubmitClicked : Aula05Action
    object OnDismissMessage : Aula05Action
}
```

### 2. UiState ‚Äî O que a tela precisa exibir

```kotlin title="ui/screens/aula05/Aula05UiState.kt"
data class Aula05UiState(
    val userName: String = "",
    val isLoading: Boolean = false,
    val successMessage: String? = null,
    val errorMessage: String? = null
)
```

### 3. ViewModel ‚Äî Processa Actions e emite UiState

```kotlin title="ui/screens/aula05/Aula05ViewModel.kt"
class Aula05ViewModel : ViewModel() {
    private val _uiState = MutableStateFlow(Aula05UiState())
    val uiState: StateFlow<Aula05UiState> = _uiState.asStateFlow()

    fun onAction(action: Aula05Action) {
        when (action) {
            is Aula05Action.OnNameChanged -> {
                _uiState.update { it.copy(userName = action.name, errorMessage = null) }
            }
            is Aula05Action.OnSubmitClicked -> {
                submitData()
            }
            is Aula05Action.OnDismissMessage -> {
                _uiState.update { it.copy(successMessage = null, errorMessage = null) }
            }
        }
    }

    private fun submitData() {
        val currentName = _uiState.value.userName
        if (currentName.isBlank()) {
            _uiState.update { it.copy(errorMessage = "O nome n√£o pode ser vazio") }
            return
        }

        // Simulando fluxo ass√≠ncrono b√°sico sem rede real ainda
        viewModelScope.launch {
            _uiState.update { it.copy(isLoading = true, errorMessage = null) }
            delay(1500) // Fake network delay
            _uiState.update {
                it.copy(
                    isLoading = false,
                    successMessage = "Usu√°rio $currentName cadastrado com sucesso!"
                )
            }
        }
    }
}
```

### 4. Screen ‚Äî Consome o estado reativo

```kotlin title="ui/screens/aula05/Aula05Screen.kt"
@Composable
fun Aula05Screen(
    modifier: Modifier = Modifier,
    viewModel: Aula05ViewModel = viewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    Column(
        modifier = modifier.fillMaxSize().padding(24.dp),
        verticalArrangement = Arrangement.Center,
        horizontalAlignment = Alignment.CenterHorizontally
    ) {
        Text(
            text = "MVVM B√°sico",
            style = MaterialTheme.typography.headlineLarge,
            color = MaterialTheme.colorScheme.primary
        )

        Spacer(modifier = Modifier.height(32.dp))

        OutlinedTextField(
            value = uiState.userName,
            onValueChange = { viewModel.onAction(Aula05Action.OnNameChanged(it)) },
            label = { Text("Nome do Aluno") },
            modifier = Modifier.fillMaxWidth(),
            isError = uiState.errorMessage != null
        )

        if (uiState.errorMessage != null) {
            Text(
                text = uiState.errorMessage!!,
                color = MaterialTheme.colorScheme.error,
                style = MaterialTheme.typography.labelSmall,
                modifier = Modifier.fillMaxWidth().padding(top = 4.dp)
            )
        }

        Spacer(modifier = Modifier.height(16.dp))

        Button(
            onClick = { viewModel.onAction(Aula05Action.OnSubmitClicked) },
            modifier = Modifier.fillMaxWidth(),
            enabled = !uiState.isLoading
        ) {
            if (uiState.isLoading) {
                CircularProgressIndicator(
                    modifier = Modifier.padding(2.dp),
                    color = MaterialTheme.colorScheme.onPrimary
                )
            } else {
                Text("Cadastrar")
            }
        }

        if (uiState.successMessage != null) {
            Spacer(modifier = Modifier.height(16.dp))
            Text(
                text = uiState.successMessage!!,
                color = MaterialTheme.colorScheme.primary,
                style = MaterialTheme.typography.titleMedium
            )
        }
    }
}
```

## üíª M√£o na Massa

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

<Tabs>
  <TabItem value="ex1" label="Exerc√≠cio 1 ‚Äî Fixa√ß√£o" default>

### Adicione uma nova Action

Crie `Aula05Action.OnClearClicked` que limpe o campo de nome. Adicione um bot√£o "Limpar" na tela que dispare essa action.

  </TabItem>
  <TabItem value="ex2" label="Exerc√≠cio 2 ‚Äî Aplica√ß√£o">

### Campo de email com valida√ß√£o

Adicione um campo `email` ao `UiState` e uma action `OnEmailChanged`. Valide no `submitData()` se o email cont√©m `@`. Exiba erro espec√≠fico no campo se inv√°lido.

  </TabItem>
  <TabItem value="ex3" label="Exerc√≠cio 3 ‚Äî Desafio">

### Formul√°rio completo com lista de registros

Integre tudo: nome + email. Ao submeter com sucesso, adicione o registro a uma `List<UserProfile>` (da Aula 02) no UiState. Exiba a lista abaixo do formul√°rio usando `Column`.

  </TabItem>
</Tabs>
